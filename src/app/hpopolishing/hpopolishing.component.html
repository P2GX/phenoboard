<div class="p-4">


  <!-- Annotation area -->
  <div class="whitespace-pre-wrap text-sm font-mono mb-4 relative">
    @for (ann of annotations; track $index) {
      @if (ann.isFenominalHit) {
        <span
          class="cursor-pointer px-1 rounded"
          (click)="openPopup(ann, $event)"
          [ngClass]="{
            'bg-green-100': ann.isObserved,
            'bg-red-100': !ann.isObserved
          }"
          [attr.data-id]="ann.termId"
        >
          {{ ann.originalText }}
        </span>
      } @else {
        {{ ann.originalText }}
      }
    }
  </div>

  <!-- Popup for one of the terms in the marked up text that will be activated if the user clicks on the colored text -->
   @if (showPopup) {
<div
    class="absolute z-50 bg-white border border-gray-300 shadow-md p-2 rounded"
    [ngStyle]="{ top: popupY + 'px', left: popupX + 'px' }"
    (mouseleave)="closePopup()"
  >
  <div class="flex justify-between items-center mb-2">
    <p class="text-sm font-semibold">Edit Annotation</p>
    <button (click)="closePopup()" class="text-gray-500 hover:text-black text-xs">✕</button>
  </div>
      <p><strong>Label:</strong> {{ selectedAnnotation?.label }}</p>
      <p><strong>Term ID:</strong> {{ selectedAnnotation?.termId }}</p>
      <p><strong>Observed:</strong> {{ selectedAnnotation?.isFenominalHit ? 'Yes' : 'No'  }}</p>
      <p><strong>Onset:</strong> {{ selectedAnnotation?.onsetString || '(none)' }}</p>
    <p class="text-xs text-gray-600 mb-1">Term: {{ selectedAnnotation?.label }}</p>
    <button
      class="text-xs px-2 py-1 mb-1 bg-gray-100 rounded w-full"
      (click)="toggleObserved(this.selectedAnnotation)"
    >Mark as {{ selectedAnnotation?.isObserved ? 'Excluded' : 'Observed' }}</button>
    <div class="mt-2">
      @if (selectedAnnotation) {
        <label class="text-xs block mb-1">Select Onset:</label>
        @for(onset of availableOnsetTerms; track onset) {
          <div class="text-xs mb-1">
            <label class="inline-flex items-center">
              <input
                type="radio"
                name="onsetGroup"
                class="mr-1"
                [value]="onset"
                [(ngModel)]="selectedAnnotation.onsetString"
              />
              {{ onset }}
            </label>
          </div>
        }
      }
    </div>
  </div>
   }


<div class="mt-4 p-2 border rounded bg-gray-50">
  <strong>Annotated Terms: n={{ getFenominalAnnotations().length }}</strong>
  <!-- text-annotations.component.html -->
<div class="max-h-64 overflow-y-auto border border-gray-300 rounded">
  <table class="table-auto w-full border-collapse text-xs leading-tight">
  <thead class="bg-gray-100 sticky top-0 z-10">
    <tr>
      <th class="border px-1 py-[1px]">Term ID</th>
      <th class="border px-1 py-[1px]">Label</th>
      <th class="border px-1 py-[1px]">Observed</th>
      <th class="border px-1 py-[1px]">Onset</th>
      <th class="border px-1 py-[1px]">Actions</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let annotation of hpoAnnotations; let i = index">
      <td class="border px-1 py-[1px]">
          <a (click)="onLinkClick($event, annotation.termId)" class="text-blue-600 underline">
            {{ annotation.termId }}
          </a></td>
        <td class="border px-1 py-[1px] relative">
  <span (click)="showParentChildDropdown(annotation)" class="cursor-pointer text-blue-600 underline">
    {{ annotation.label }} ▼
  </span>

  @if (showDropdownMap[annotation.termId]) {
    <div class="absolute left-0 top-full z-10 bg-white border border-gray-300 mt-1 max-h-40 overflow-y-auto w-max min-w-full shadow-lg">
      
      @if (!parentChildHpoTermMap[annotation.termId]) {
        <div class="p-2 text-gray-500 text-sm italic">
          Loading...
        </div>
      }

      @if (parentChildHpoTermMap[annotation.termId]) {
        <div class="text-xs font-bold text-gray-500 px-2 pt-2">Parents</div>
        <ul>
          @for (parent of parentChildHpoTermMap[annotation.termId].parents; track parent.termId) {
            <li
              (click)="replaceTerm(annotation, parent)"
              class="px-2 py-1 hover:bg-gray-100 cursor-pointer text-sm"
            >
              {{ parent.label }} ({{ parent.termId }})
            </li>
          }
        </ul>

        <div class="text-xs font-bold text-gray-500 px-2 pt-2">Children</div>
        <ul>
          @for (child of parentChildHpoTermMap[annotation.termId].children; track child.termId) {
            <li
              (click)="replaceTerm(annotation, child)"
              class="px-2 py-1 hover:bg-gray-100 cursor-pointer text-sm"
            >
              {{ child.label }} ({{ child.termId }})
            </li>
          }
        </ul>
      }
    </div>
  }
</td>


        <td class="border px-1 py-[1px]">
        <span [class.text-green-600]="annotation.isObserved" [class.text-red-600]="!annotation.isObserved">
          {{ annotation.isObserved ? 'Yes' : 'No' }}
        </span>
      </td>
      <td class="border px-1 py-[1px]">{{ annotation.onsetString }}</td>
      <td class="border px-1 py-[1px] flex gap-1 flex-wrap items-center">
        <button (click)="deleteAnnotation(i)" class="bg-red-500 text-white px-1 py-0.5 text-[10px] rounded">Delete</button>
        <button (click)="toggleObserved(annotation)" class="bg-blue-500 text-white px-1 py-0.5 text-[10px] rounded">Toggle</button>
        <select #onsetSelect
            (change)="updateOnset(annotation, onsetSelect.value)"
            class="px-1 py-0.5 border rounded text--[10px] h-5"
          >
          @for (option of availableOnsetTerms; track option) {  
            <option
              [value]="option"
              [selected]="option === annotation.onsetString"
            >
              {{ option }}
            </option>
          }
        </select>
        <button (click)="addOnsetString()" class="bg-green-500 text-white px-1 py-0.5 text-[10px] rounded">Add onset</button>
      </td>
    </tr>
  </tbody>
</table>
</div>

<div class="space-y-1">
  <app-hpoautocomplete
    [inputString]="hpoInputString"
    (selected)="selectedHpoTerm = $event"
    [onSubmit]="submitSelectedHpo"
    #hpoAutocomplete
  ><span card-title>Add new HPO term</span></app-hpoautocomplete>
  <p class="text-xs">Selected HPO Term: {{ selectedHpoTerm }}</p>
</div>

</div>
  <!-- Done button -->
  <div class="flex justify-end mt-4">
    <button
      class="btn-outline-primary"
      (click)="finish()"
    >
      Finish
    </button>
     <button class="btn-outline-primary" (click)="onCancel()">Cancel</button>
  </div>
</div>
