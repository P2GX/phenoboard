@let cohort = cohortDto;

<div class="p-6 bg-gray-50">
  @if (cohort) {
    <div class="text-sm text-gray-700 space-y-2">
      <h2 class="text-xl font-semibold text-gray-800">
        <strong>{{ cohort.cohortType }}</strong> cohort  </h2>
        <ul>@for (disease of cohort.diseaseList; track disease.diseaseId; let i = $index) {
          <li> <a [href]="'https://omim.org/entry/' + getOmimId(disease.diseaseId)" 
              target="_blank" class="text-blue-600 underline">
              {{ disease.diseaseLabel }} ({{ disease.diseaseId }})
            </a>
            {{ disease.diseaseLabel }}
            @if (disease.geneTranscriptList.length){
              (
                @for (gene  of disease.geneTranscriptList; track gene; let j =$index) {
                <i>{{ gene.geneSymbol }}</i
                >{{ j < disease.geneTranscriptList.length - 1 ? ', ' : '' }}
                }
              )
            }</li>
        }
        </ul>
      <p>
        This is a <strong>{{ cohort.cohortType }}</strong> cohort of 
        <strong>{{ cohort.rows.length }}</strong> individuals. {{ numVariants }} Variants were identified. 
        <strong>{{ cohort.hpoHeaders.length }}</strong> distinct HPO terms were observed.</p>
        <p> 
      </p>
    </div>
  } @else {
    <p>Cohort not initialized.</p>
  }

<!-- String input section -->
<div class="mt-4">

  <!-- Action buttons side by side -->
  <div class="flex gap-4">
    <!-- Cohort acronym button or input -->
    <div>
      @if (!showCohortAcronym) {
        <button 
          (click)="showCohortAcronym = true"
          class="btn-outline-primary"
        >
          Set cohort acronym
        </button>
      } @else {
        <div class="flex gap-2 items-center">
          <input 
            #acronymInput
            type="text" 
            [(ngModel)]="cohortAcronymInput"
            placeholder="Enter cohort acronym..."
            class="px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 flex-1"
            (keyup.enter)="submitCohortAcronym(acronymInput.value)"
          />
          <button 
            (click)="submitCohortAcronym(acronymInput.value)"
            class="btn-outline-primary"
          >
            Submit
          </button>
          <button 
            (click)="cancelCohortAcronym()"
            class="btn-outline-cancel"
          >
            Cancel
          </button>
        </div>
      }
        <div class="text-xs text-gray-500 mt-1">
            {{ cohort != null && cohort.cohortAcronym != "na" ? 'Acronym: ' + cohort.cohortAcronym : "Acronym not set" }}
        </div>
      
    </div>

    <!-- Mode of inheritance button -->
   @if (cohort) {
  <ul class="space-y-2">
    @for (disease of cohort.diseaseList; track disease.diseaseId; let i = $index) {
      <li class="flex flex-col border-b border-gray-200 pb-1">
        <div class="flex items-center justify-between text-sm">
          <span class="font-medium text-gray-800">
            {{ disease.diseaseLabel }}
          </span>
          <button
            (click)="toggleMoiSelector(i)"
            [class]="
              'ml-2 text-xs rounded-md px-2 py-0.5 border transition-colors ' +
              (showMoiIndex === i
                ? 'text-white bg-blue-600 border-blue-600 hover:bg-blue-700'
                : 'text-blue-600 border-blue-300 hover:bg-blue-50 hover:border-blue-400')
            "
          >
            {{ showMoiIndex === i ? 'Hide' : 'Set MOI' }}
        </button>
        </div>

        <!-- inline list of MOIs -->
        <div class="text-xs text-gray-500 truncate">
          @if (disease.modeOfInheritanceList.length > 0) {
            @for (moi of disease.modeOfInheritanceList; track moi.hpoId) {
              <span>
                <i>{{ moi.hpoLabel }}</i>{{ moi.citation ? ' ‚Äî ' + moi.citation : '' }}
                {{ $last ? '' : ', ' }}
              </span>
            }
          } @else {
            <span class="italic text-gray-400">No MOI set</span>
          }
        </div>

        @if (showMoiIndex === i) {
          <div class="mt-1">
            <app-moiselector (moiChange)="onMoiChange($event, i)"></app-moiselector>
          </div>
        }
      </li>
    }
  </ul>
}


      <button (click)="toggleVariantColumn()" class="btn-outline-primary">
      @if(showAlleleColumn){
          Hide allele
      } @else {
          Show allele
      }
    </button>

    </div>
  </div>
</div>
<div class="mt-4 flex items-center gap-2">
  <label for="hpoFilter" class="text-sm text-gray-700">Filter HPO columns:</label>
  <select
    id="hpoFilter"
    [(ngModel)]="selectedTopLevelHpo"
    (change)="onHpoFilterChange()"
    class="border rounded p-1 text-sm"
  >
    <option [ngValue]="null">Show all</option>
    @for (groupKey of hpoGroupKeys; track groupKey) {
      <option [ngValue]="groupKey">
        {{ groupKey }}
      </option>
    }
  </select>
</div>

  <!-- Table with one row per phenopacket -->
  @if (cohort){
  <div class="pt-table-container">
    <div class="top-scroll-mirror overflow-x-auto invisible-scrollbar">
       <div class="h-1" [style.width]="tableWidth"></div>
     </div>
     <div class="overflow-y-auto max-h-[600px] max-w-7xl">
  <table class="pt-table">
    <thead class="sticky top-0 z-10 bg-white shadow-sm border-b border-gray-200">
    <tr>
      <th class="narrow-column bottom-align">Individual ID</th>
      @if(showAlleleColumn){
          <th class="narrow-column bottom-align">
            Alleles
          </th>
          <th class="narrow-column bottom-align">
            Add allele
          </th>
        }
      <!-- The following creates the series of headers for the HPO columns.
          The function shouldDisplayHpoColumn allows the user to focus on 1-10 columns at a time-->
      @if (cohort) {
          @for (header of cohort.hpoHeaders; track header.hpoId; let i = $index) {
            @if (visibleColumns.includes(i)) {
              <th
                class="rotate-header hpo-col hpo-col-th"
                (mouseenter)="setHover('hpoHeader', 0, $index, true)"
                (mouseleave)="setHover('hpoHeader', 0, $index, false)"
              >
                <div class="rotated-text" [ngClass]="{ 'hover-underline': true }">
                  {{ header.hpoLabel }}
                </div>
              <!-- Popup shown on hover -->
              @if(isHovered('hpoHeader', 0, $index)) {
                  <div class="hpo-popup">
                    <a
                      [href]="'https://hpo.jax.org/browse/term/' + header.hpoId"
                      target="_blank"
                      rel="noopener"
                    >
                      üîó {{ header.hpoId }}
                    </a>
                  </div>
                }
              </th>
            }
          }
        }
  </tr>
  </thead>
    <tbody>
      @for (row of getDisplayedRows(); track getRowKey(row);  let rowIndex = $index) {
      <tr >
        <!-- First column: PMID/title/individual_id/comment -->
        <td class="relative narrow-column"
          (contextmenu)="onIndividualRightClick($event, row)"
          class="cursor-context-menu">
          {{ row.individualData.individualId }}
          @if(!row.individualData.individualId){ <span class="text-red-500 text-xs">[ID is null/empty]</span> }
          <!-- Info popup for this row -->
          @if (rowInfoVisible && getRowKey(row) === rowInfoKey) {
            <div
              class="fixed bg-white border border-gray-300 rounded shadow-md z-[999] text-sm"
              [style.left.px]="individualMenuX"
              [style.top.px]="individualMenuY"
            >
              <ul class="list-disc list-inside text-sm text-gray-800 mb-2">
                <li><strong>{{ row.individualData.individualId }}</strong></li>
                <li>PMID: {{ row.individualData.pmid }}</li>
                <li>{{ row.individualData.title }}</li>
                @if(row.individualData.comment && row.individualData.comment.length > 0){
                  <li><strong>Comment:</strong> {{ row.individualData.comment }}</li>
                }
                <li>onset: {{ row.individualData.ageOfOnset }}</li>
                <li>last encounter: {{ row.individualData.ageAtLastEncounter }}</li>
                <li>deceased: {{ row.individualData.deceased }}</li>
                <li>sex: {{ row.individualData.sex }}</li>
              </ul>

              <button
                mat-stroked-button
                color="primary"
                class="text-xs py-0 px-2"
                (click)="openIndividualEditor(row.individualData); $event.stopPropagation();"
              >
                ‚úèÔ∏è Edit
              </button>
              <button
                mat-stroked-button
                color="warn"
                class="text-xs py-0 px-2 ml-2"
                (click)="closeRowInfo(); $event.stopPropagation();"
              >
                ‚úñÔ∏è Close
              </button>
            </div>
          } 
        </td>

        <!-- Second column for gene/allele -->
        @if(showAlleleColumn){
        <td class="relative narrow-column">
        @for (geneSymbol of getAlleleKeys(row.alleleCountMap); track geneSymbol; let gi = $index) {

        <div
          class="relative flex items-center justify-between"
          (mouseenter)="setHover('gene', rowIndex, gi, true)"
          (mouseleave)="setHover('gene', rowIndex, gi, false)"
        >
          <div class="flex items-center gap-x-1">
            <span 
              class="inline-block w-3 h-3 rounded-full"
              [ngClass]="isAlleleValidated(geneSymbol) ? 'bg-green-500' : 'bg-red-500'"
              title="{{ isAlleleValidated(geneSymbol) ? 'Validated' : 'Not validated' }}"
            ></span>
            <span class="cursor-pointer">
              {{   getShortAlleleDisplay(geneSymbol, row.alleleCountMap[geneSymbol])  }}
            </span>
          </div>

          <!-- Right side: actions -->
          <div class="flex items-center gap-x-2">
            <mat-button-toggle-group
              [value]="row.alleleCountMap[geneSymbol] || 0"
              (change)="onAlleleCountChange(geneSymbol, row, $event.value)"
              appearance="legacy"
              class="allele-toggle-group"
              appearance="legacy"
              aria-label="Select allele count">

              <mat-button-toggle [value]="1">1</mat-button-toggle>
              <mat-button-toggle [value]="2">2</mat-button-toggle>
              <mat-button-toggle [value]="0" aria-label="Delete">üóëÔ∏è</mat-button-toggle>
            </mat-button-toggle-group>
       
          </div>
        </div>
        } <!-- for gene -->
    </td>
    <td>
      <button mat-icon-button
              aria-label="Add HGVS"
              (click)="addAllele(row)">
        <mat-icon class="small-icon">add</mat-icon>
        <span class="button-label">HGVS</span>
        </button>
      <button mat-icon-button
              aria-label="Add SV"
              (click)="openSvEditor(row)">
        <mat-icon class="small-icon">‚ûï</mat-icon>
        <span class="button-label">SV</span>
        </button>
      </td>
    }<!-- isShowAllele -->

    <!-- The values of the HPO columns-->
    @for (cell of row.hpoData; track $index; let hpoIndex = $index) {
      @if(visibleColumns.includes(hpoIndex)) {
      <td
        class="hpo-col"
        (contextmenu)="onRightClick($event, hpoIndex, rowIndex, row, cell)"
        [class.observed-cell]="cell.type=='Observed'"
        [class.excluded-cell]="cell.type=='Excluded'"
        [class.onset-cell]="cell.type=='OnsetAge'"
        [class.na-cell]="cell.type=='Na'"
      >
        @switch (cell.type) {
          @case ('Observed') {  ‚úÖ }
          @case ('Excluded') {  ‚ùå  }
          @case ('Na') { n/a }
          @case ('OnsetAge') {
            <div class="onset-content" [title]="cell.data">
              <span class="onset-icon">üïí</span>
              <span class="onset-text">{{ cell.data }}</span>
            </div>
          }
          @case ('Modifier') {
            <div
              class="truncate max-w-[4rem] overflow-hidden whitespace-nowrap"
              [title]="cell.data"
            >
              {{ cell.data }}
            </div>
          }
          @default {
            <span>Unknown</span>
          }
        }
      </td>
      }
    }

  } <!-- end of for over the tr -->
    </tbody>
  </table>
  </div>
  <div style="height: 40px;"></div>
  </div>
} <!-- close  @if (cohort){ -->


  <!-- Toolbar / Controls -->
<div class="flex items-center gap-6 p-4 bg-white rounded-lg shadow-sm border border-gray-200">
  <!-- HPO Autocomplete -->
  <div class="flex flex-col ">
    <label class="text-xs font-medium text-gray-600 mb-1">Add HPO Term</label>
    <app-hpoautocomplete
      [inputString]="hpoInputString"
      (selected)="selectedHpoTerm = $event"
      [onSubmit]="submitSelectedHpo"
      #hpoAutocomplete
      class="w-full"
    ></app-hpoautocomplete>
  </div>

  <!-- Add Ages -->
 <div
  class="flex items-center gap-4 p-3 border rounded"
  style="border-color: #e9ecef; margin-bottom:10px;"
>
  <button mat-stroked-button color="primary" (click)="openAgeDialog()">
    Add/Edit Age Entries
  </button>
  <div class="flex flex-wrap gap-2 text-xs text-gray-600">
    @for (entry of ageEntries; track entry; let i = $index) {
      <span class="bg-gray-100 px-2 py-1 rounded">{{ entry }}</span>
    }
  </div>
</div>

 <!-- Actions -->
<div class="flex flex-col gap-2 ml-auto">
  <!-- First Row -->
  <div class="flex items-center gap-3">
    <button 
      (click)="validateCohort()" 
      class="px-4 py-2 text-sm rounded-lg border border-blue-600 text-blue-600 hover:bg-blue-50 transition"
    >
      Validate
    </button>
    <button 
      (click)="sanitizeCohort()" 
      class="px-4 py-2 text-sm rounded-lg border border-blue-600 text-blue-600 hover:bg-blue-50 transition"
    >
      Sanitize
    </button>
    <button 
      (click)="saveCohort()" 
      class="px-4 py-2 text-sm rounded-lg border border-green-600 text-green-600 hover:bg-green-50 transition"
    >
      Save
    </button>
    <button 
      (click)="recordBiocuration()" 
      class="px-4 py-2 text-sm rounded-lg border border-orange-600 text-orange-600 hover:bg-orange-50 transition"
    >
      Record Biocuration
    </button>
  </div>
  
  <!-- Second Row -->
  <div class="flex items-center gap-3">
    
    <button 
      (click)="exportPpkt()" 
      class="px-4 py-2 text-sm rounded-lg border border-purple-600 text-purple-600 hover:bg-purple-50 transition"
    >
      Export phenopackets
    </button>
    <button 
      (click)="exportHpoa()" 
      class="px-4 py-2 text-sm rounded-lg border border-purple-600 text-purple-600 hover:bg-pink-50 transition"
    >
      Export Hpoa
    </button>
  </div>
</div>
</div>

<!-- Context Menu (appears after right-click on HPO cell)-->
@if (contextMenuVisible) {
  <div
    [ngStyle]="{ top: contextMenuY + 'px', left: contextMenuX + 'px' }"
    class="absolute z-50 bg-white border border-gray-300 rounded-lg shadow-md p-2 text-sm w-44"
    role="menu"
    aria-label="Annotation context menu"
  >
    @for (option of contextMenuOptions; track option) {
      <button
        class="block w-full text-left px-3 py-2 rounded-md hover:bg-gray-100 focus:outline-none focus:bg-gray-200 transition"
        role="menuitem"
        (click)="onMenuOptionClick(option.value)"
        type="button"
      >
        {{ option.label }}
      </button>
    }
  </div>
}

<!-- Individual (row-level) context menu -->
 @if (individualContextMenuVisible) {
  <div
    class="absolute bg-white border border-gray-300 rounded shadow-md z-50 text-sm"
    [style.left.px]="individualMenuX"
    [style.top.px]="individualMenuY"
  >
    <ul>
      <li class="px-3 py-1 cursor-pointer hover:bg-gray-100"
          (click)="focusOnRow()">Focus on row</li>
      <li class="px-3 py-1 cursor-pointer hover:bg-gray-100"
          (click)="focusOnPmid()">Focus on PMID: {{ contextRow?.individualData.pmid }}</li>
      <li class="px-3 py-1 cursor-pointer hover:bg-gray-100"
          (click)="showAllRows()">Show all rows</li>
      <li class="px-3 py-1 cursor-pointer hover:bg-gray-100"
          (click)="showInfoForRow(contextRow)">Show info</li>
    </ul>
  </div>
}
