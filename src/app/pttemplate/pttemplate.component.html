@let cohort = (cohortDto$ | async);

<div class="p-6 space-y-6 bg-gray-50 min-h-screen">
  <!-- Title and description of cohort -->
  @if (cohortDescription) {
    <div class="mb-4 text-sm text-gray-700">
      <h2 class="text-xl font-semibold text-gray-800">
        {{ cohortDescription.geneSymbol }}: {{ cohortDescription.diseaseLabel }}
      </h2>

      <p>
        This is a <strong>{{ cohortDescription.cohortType }}</strong> cohort with 
        <strong>{{ cohortDescription.numIndividuals }}</strong> individuals and 
        <strong>{{ cohortDescription.numHpos }}</strong> distinct HPO terms.
        Most individuals are diagnosed with 
      </p>

      @if (cohortDescription.diseaseDatabase == "OMIM") {
        <a [href]="'https://omim.org/entry/' + cohortDescription.diseaseId" 
           target="_blank" class="text-blue-600 underline">
          {{ cohortDescription.diseaseLabel }} ({{ cohortDescription.diseaseId }})
        </a>
      } @else {
        <span>{{ cohortDescription.diseaseLabel }} ({{ cohortDescription.diseaseId }})</span>
      }

      <p>
        , associated with 
        <a [href]="'https://www.genenames.org/data/gene-symbol-report/#!/hgnc_id/' + cohortDescription.hgncId" 
           target="_blank" class="text-blue-600 underline">
          {{ cohortDescription.geneSymbol }} ({{ cohortDescription.hgncId }})
        </a>,
        transcript <code>{{ cohortDescription.transcript }}</code>.
      </p>
    </div>
  }
</div>
  <!-- Table with one row per phenopacket -->
  @if (cohort){
  <table class="pt-table">
    <thead>
    <tr>
      <th class="narrow-column bottom-align">Individual ID</th>
      <th class="narrow-column bottom-align">Disease</th>
      <th class="narrow-column bottom-align">Gene</th>
      <!-- The following creates the series of headers for the HPO columns.
          The function shouldDisplayHpoColumn allows the user to focus on 1-10 columns at a time-->
      @if (cohort) {
          <ng-container *ngFor="let header of cohort.hpoHeaders; let i = index">
           <th
              class="rotate-header hpo-col"
              *ngIf="shouldDisplayHpoColumn(i)"
              (mouseenter)="setHover('hpoHeader', 0, i, true)"
              (mouseleave)="setHover('hpoHeader', 0, i, false)"
            >
              <div class="rotated-text" *ngIf="isHovered('hpoHeader', 0, i)" [ngClass]="{ 'hover-underline': true }">
                {{ header.h1 }}
              </div>

              <!-- Popup shown on hover -->
              <div *ngIf="isHovered('hpoHeader', 0, i)" class="hpo-popup">
                <a
                  [href]="'https://hpo.jax.org/browse/term/' + header.h2"
                  target="_blank"
                  rel="noopener"
                >
                  üîó {{ header.h2 }}
                </a>
              </div>
            </th>

          </ng-container>
        }
  </tr>
  </thead>
    <tbody>
      <tr *ngFor="let row of cohort.rows; let rowIndex = index">
        <!-- First column: PMID/title/individual_id/comment -->
        <td class="relative narrow-column">
        <div 
            (mouseenter)="setHover('individual', rowIndex, 0, true)"
            (mouseenter)="setHover('individual', rowIndex, 0, false)"
          class="cursor-pointer"
        >
          {{ row.individualDto.individualId }}
           <span *ngIf="!row.individualDto.individualId" class="text-red-500 text-xs">
        [ID is null/empty] row={{row}}
      </span>
        <div
          *ngIf="isHovered('hpoHeader', rowIndex, 0)"
          class="absolute top-0 left-0 ml-2 bg-white shadow-md border p-2 rounded z-50 w-64"
            (mouseenter)="setHover('individual', rowIndex, 0, true)"
            (mouseenter)="setHover('individual', rowIndex, 0, false)"
        >
          <ul class="list-disc list-inside text-sm text-gray-800 mb-2">
            <li><strong>{{ row.individualDto.individualId }}</strong></li>
            <li>{{ row.individualDto.pmid }}</li>
            <li>{{ row.individualDto.title }}</li>
            <li *ngIf="row.individualDto.comment.length > 0">
              <strong>Comment:</strong> {{ row.individualDto.comment }}
            </li>
            <li>onset: {{ row.individualDto.ageOfOnset }}</li>
            <li>last encounter: {{ row.individualDto.ageAtLastEncounter }}</li>
            <li>deceased: {{ row.individualDto.deceased }}</li>
            <li>sex: {{ row.individualDto.sex }}</li>
          </ul>
          <!-- Edit button in popup -->
          <button
            mat-stroked-button
            color="primary"
            class="text-xs py-0 px-2"
            (click)="openIndividualEditor(row.individualDto); $event.stopPropagation();"
          >
            ‚úèÔ∏è Edit
          </button>
        </div>
      </div>
    </td>

<!-- Second column: disease/id -->
<td class="relative narrow-column">
  <div
    *ngFor="let disease of row.diseaseDtoList ?? []; let di = index"
    class="relative inline-block"
    (mouseenter)="setHover('disease', rowIndex, di, true)"
    (mouseleave)="setHover('disease', rowIndex, di, false)"
  >
    <span class="cursor-pointer">{{ disease.diseaseId }}</span>

    <div
      *ngIf="isHovered('disease', rowIndex, di)"
      class="absolute top-0 left-full -ml-4 bg-white shadow-md border p-2 rounded z-50 w-64"
      (mouseenter)="setHover('disease', rowIndex, di, true)"
      (mouseleave)="setHover('disease', rowIndex, di, false)"
    >
      <!-- popup content -->
    </div>
  </div>
</td>

 <!-- Third column for gene/var-->
  <td class="relative narrow-column">
  <div
      *ngFor="let gene of row.geneVarDtoList ?? []; let gi = index"
      class="relative inline-block"
      (mouseenter)="setHover('gene', rowIndex, gi, true)"
      (mouseleave)="setHover('gene', rowIndex, gi, false)"
    >
      <span class="cursor-pointer">{{ gene.geneSymbol }}</span>
    <div
        *ngIf="isHovered('gene', rowIndex, gi)"
        class="absolute top-0 left-full -ml-4 bg-white shadow-md border p-2 rounded z-50 w-64"
        (mouseenter)="setHover('gene', rowIndex, gi, true)"
        (mouseleave)="setHover('gene', rowIndex, gi, false)"
      >
      <ul class="list-disc list-inside text-sm text-gray-800 break-words">
        <li><strong>{{ gene.geneSymbol }}</strong></li>
        <li>{{ gene.hgncId }}</li>
        <li>transcript: {{ gene.transcript }}</li>
        <li>allele 1: {{ gene.allele1 }}</li>
        <li *ngIf="gene.allele2!=='na'">allele 2: {{ gene.allele2 }}</li>
        <li *ngIf="gene.variantComment.length > 0">
          <strong>Comment:</strong> {{ gene.variantComment }}
        </li>
      </ul>

      <button
        mat-stroked-button
        color="primary"
        class="text-xs py-0 px-2"
        (click)="openGeneEditor(gene); $event.stopPropagation();"
      >
        ‚úèÔ∏è Edit
      </button>
    </div>
  </div>
</td>
<!-- The values of the HPO columns-->
    <ng-container *ngFor="let cell of row.hpoData; let i = index">
      <td  *ngIf="shouldDisplayHpoColumn(i)"
          class="hpo-col"
          (contextmenu)="onRightClick($event, i, rowIndex, cell)"
          [ngClass]="{
            'observed-cell': cell.value === 'observed',
            'excluded-cell': cell.value === 'excluded',
            'na-cell': cell.value === 'na'
          }"
      >
        <ng-container [ngSwitch]="cell.value">
          <ng-container *ngSwitchCase="'observed'">‚úÖ</ng-container>
          <ng-container *ngSwitchCase="'excluded'">‚ùå</ng-container>
          <ng-container *ngSwitchCase="'na'">n/a</ng-container>
          <ng-container *ngSwitchDefault>
            <div
              class="truncate max-w-[4rem] overflow-hidden whitespace-nowrap"
              [title]="cell.value"
            >
              {{ cell.value }}
            </div>
          </ng-container>
        </ng-container>
      </td>
    </ng-container>
      </tr>
    </tbody>
  </table>
} <!-- close  @if (cohort){ -->


  <!-- Left side: Inputs -->
  <div class="flex items-center gap-6">
    <!-- HPO Autocomplete -->
    <div class="space-y-1">
      <app-hpoautocomplete
        [inputString]="hpoInputString"
        (selected)="selectedHpoTerm = $event"
        [onSubmit]="submitSelectedHpo"
        #hpoAutocomplete
      >
        <span card-title>Add a new HPO term to template</span>
      </app-hpoautocomplete>
    </div>

    <!-- Add Ages -->
    <app-addages #addagesComponent><span card-title>Add a new Onset</span></app-addages>
    <div class="primary-box  flex  gap-4 h-full">
    <button (click)="validateCohort()" 
          class="btn-outline-primary whitespace-nowrap align-middle leading-none"
          >Validate</button>
    <button (click)="saveCohort()" 
          class="btn-outline-primary whitespace-nowrap align-middle leading-none">Save</button>
    <button (click)="exportPpkt()" 
          class="btn-outline-primary whitespace-nowrap align-middle leading-none">Export phenopackets</button>
  </div>

  </div>

@if(contextMenuVisible) {
  <div
    [ngStyle]="{ top: contextMenuY + 'px', left: contextMenuX + 'px' }"
    class="absolute z-50 bg-white border border-gray-300 rounded shadow-md p-2 text-sm w-40"
    role="menu"
    aria-label="Annotation context menu"
  >
  @for (option of contextMenuOptions; track option) {
    <button
      class="block w-full text-left hover:bg-gray-100 px-2 py-1 rounded focus:outline-none focus:bg-gray-200"
      role="menuitem"
      (click)="onMenuOptionClick(option.value)"
      type="button"
    >
      {{ option.label }}
    </button>
  }
  </div>
}

@if (cohort) {
    <pre>{{ cohort | json }}</pre>
}

