
<div class="p-6 bg-gray-50">
  @if (cohortData(); as cohort) {
    <app-cohort-summary [cohort]="cohort"></app-cohort-summary>
  } @else {
    <p>Cohort not initialized.</p>
  }

<!-- String input section -->
<div class="mt-4">
 <app-cohort-metadata 
  [cohortData]="cohortData()!" 
  (resetCohortMetadata)="handleReset()"
  (updateAcronym)="handleAcronym($any($event))"
  (updateMoi)="handleMoi($any($event))">
  </app-cohort-metadata>

  <div class="mt-4 flex items-center gap-2">
    <label for="hpoFilter" class="text-sm text-gray-700">Filter HPO columns:</label>
    <select
    id="hpoFilter"
    class="border rounded p-1 text-sm"
    [value]="selectedTopLevelHpo()"
    (change)="selectedTopLevelHpo.set($any($event.target).value)"
  >
    <option value="">Show all</option>
    @for (groupKey of hpoGroupKeys(); track groupKey) {
      <option [value]="groupKey">{{ groupKey }}</option>
    }
  </select>
  <app-help-button 
            title="Filter HPO columns"
            [lines]="[
              'Filter to the columns shown in the display to the indicated top-level HPO category.',
              'The categories correspond to top-level HPO terms (direct children of <i>Phenotypic abnormality</i>).',
              'Choose <i>Show all</i> to restore the original view.'
            ]" />
  </div>

  <!-- Table with one row per phenopacket -->
  @if (cohortData(); as cohort){
  <div class="pt-table-container">
    <div class="top-scroll-mirror overflow-x-auto invisible-scrollbar">
      <div class="h-1" [style.width]="tableWidth"></div>
    </div>
    <div class="overflow-y-auto max-h-[600px] max-w-7xl">
    <table class="pt-table">
      <thead class="sticky top-0 z-10 bg-white shadow-sm border-b border-gray-200">
        <tr>
        <th class="narrow-column bottom-align">Individual ID</th>

            <th class="narrow-column bottom-align">
              Alleles
            </th>
        <!-- The following creates the series of headers for the HPO columns.
            The function shouldDisplayHpoColumn allows the user to focus on 1-10 columns at a time-->
        @if (cohort) {
            @for (header of cohort.hpoHeaders; track header.hpoId; let i = $index) {
              @if (visibleColumnMask()[i]) {
                <th
                  class="rotate-header hpo-col hpo-col-th"
                  (mouseenter)="onHeaderMouseEnter(i)"
                  (mouseleave)="onHeaderMouseLeave()"
                >
                  <div class="rotated-text" [ngClass]="{ 'hover-underline': true }">
                    {{ header.hpoLabel }}
                  </div>
                <!-- Popup shown on hover -->
                @if(isHeaderHovered(i)) {
                    <div class="hpo-popup">
                      <a
                        [href]="'https://hpo.jax.org/browse/term/' + header.hpoId"
                        target="_blank"
                        rel="noopener"
                      >
                        üîó {{ header.hpoId }}
                      </a>
                    </div>
                  }
                </th>
              }
            }
          }
        </tr>
      </thead>
      <tbody>
      @for (row of tableVM(); track row.id;  let rowIndex = $index) {
      <tr [class.bg-red-50]="!row.hasObservedHpo">
        <!-- First column: PMID/title/individual_id/comment -->
        <td class="relative narrow-column"
          (contextmenu)="onIndividualRightClick($event, row.id)"
          class="cursor-context-menu">
          {{ row.individualId }}
          @if(!row.individualId){ <span class="text-red-500 text-xs">[ID is null/empty]</span> }
          <!-- Info popup for this row -->
          @if (rowInfoVisible && row.id === rowInfoKey) {
            @let currentRow = rowMapById().get(rowInfoKey);
            <div
              class="fixed bg-white border border-gray-300 rounded shadow-md z-[999] text-sm"
              [style.left.px]="individualMenuX"
              [style.top.px]="individualMenuY"
            >
              <ul class="list-disc list-inside text-sm text-gray-800 mb-2">
                <li><strong>{{ currentRow?.individualData?.individualId }}</strong></li>
                <li>PMID: {{ currentRow?.individualData?.pmid }}</li>
                <li>{{ currentRow?.individualData?.title }}</li>
                @if(currentRow?.individualData?.comment; as comment){
                  <li><strong>Comment:</strong> {{ comment }}</li>
                }
                <li>onset: {{ currentRow?.individualData?.ageOfOnset }}</li>
                <li>last encounter: {{ currentRow?.individualData?.ageAtLastEncounter }}</li>
                <li>deceased: {{ currentRow?.individualData?.deceased }}</li>
                <li>sex: {{ currentRow?.individualData?.sex }}</li>
              </ul>

              <button
                mat-stroked-button
                color="primary"
                class="text-xs py-0 px-2"
                (click)="openIndividualEditor(rowInfoKey!); $event.stopPropagation();"
              >
                ‚úèÔ∏è Edit
              </button>
              <button
                mat-stroked-button
                color="warn"
                class="text-xs py-0 px-2 ml-2"
                (click)="closeRowInfo(); $event.stopPropagation();"
              >
                ‚úñÔ∏è Close
              </button>
            </div>
          } 
        </td>

        <!-- Second column for gene/allele -->
     

<td class="relative narrow-column">
  @if (row.alleles.length === 0) {
    <button cdkOverlayOrigin #originEmpty="cdkOverlayOrigin"
            class="allele-btn allele-btn-add" (click)="openAddAlleleRowId = row.id">+</button>
    
    <app-popover [trigger]="originEmpty" [isOpen]="openAddAlleleRowId === row.id">
      <ng-container *ngTemplateOutlet="alleleMenuContent"></ng-container>
    </app-popover>
  }
  @for (allele of row.alleles; track allele.key) {
    <div class="allele-row flex items-center gap-x-3">
       <div class="flex items-center gap-x-1 allele-content">
            <span 
              class="inline-block w-3 h-3 rounded-full"
              [ngClass]="allele.validated ? 'bg-green-500' : 'bg-red-500'"
              [title]="allele.validated ? 'Validated' : 'Not validated'"
            ></span>
            <span class="cursor-pointer">
              {{ allele.shortDisplay }}
            </span>
          </div>
      <div class="allele-count-grid">
          <button 
                  class="allele-btn allele-btn-count" 
                  [ngClass]="{ 'selected-count': allele.count === 1 }"
                  (click)="onAlleleCountChange(allele.key, row.id, 1)">1</button>
                <button class="allele-btn allele-btn-count"
                  [ngClass]="{ 'selected-count': allele.count === 2 }"
                  (click)="onAlleleCountChange(allele.key, row.id, 2)">2</button>
                <button 
                  class="allele-btn allele-btn-delete" 
                  (click)="onAlleleCountChange(allele.key, row.id, 0)">üóëÔ∏è</button>
         <button cdkOverlayOrigin #originList="cdkOverlayOrigin"
                 class="allele-btn allele-btn-add" (click)="openAddAlleleRowId = row.id">+</button>
          <app-popover [trigger]="originList" [isOpen]="openAddAlleleRowId === row.id">
           <ng-container *ngTemplateOutlet="alleleMenuContent"></ng-container>
         </app-popover>
      </div>
    </div>
  }

  <ng-template #alleleMenuContent>
    <div class="grid grid-cols-2 gap-2 w-[220px]">
      <button type="button" class="allele-tile"  (click)="addAllele(row.id, VariantKind.HGVS); openAddAlleleRowId = null">HGVS</button>
      <button type="button" class="allele-tile"  (click)="addAllele(row.id, VariantKind.SV); openAddAlleleRowId = null">SV</button>
      <button type="button" class="allele-tile"  (click)="addAllele(row.id, VariantKind.INTERGENIC); openAddAlleleRowId = null">Intergenic</button>
      <button type="button" class="allele-tile"  (click)="addAllele(row.id, VariantKind.SV); openAddAlleleRowId = null">Mito</button>
    </div>
  </ng-template>
</td>

    <!-- The values of the HPO columns-->
    @for (cell of row.hpoCells; track $index; let hpoIndex = $index) {
      @if (visibleColumnMask()[hpoIndex]) {
          <td class="hpo-col" 
          [ngClass]="cell.cssClass" 
          style="width: 2.5rem; height: 2.5rem;"
          (contextmenu)="onRightClick($event, hpoIndex, rowIndex, row.id, cell.originalCell)">
          @switch (cell.originalCell.type) {
            @case ('Observed') {
              <span>‚úÖ</span>
            }
            @case ('Excluded') {
              <span>‚ùå</span>
            }
            @case ('Na') {
              <span>n/a</span>
            }
            @case ('OnsetAge') {
              <div class="onset-content" [title]="cell.displayValue">
                <span class="onset-icon">üïí</span>
                <span class="onset-text"></span>
              </div>
            }
            @case ('Modifier') {
             <div class="truncate max-w-[4rem] overflow-hidden whitespace-nowrap" [title]="cell.displayValue">
                  {{ cell.displayValue }}
                </div>
            }
            @default {
                <span>Unknown</span>
            }
          }
        </td>
      }
    }

  } <!-- end of for over the tr -->
    </tbody>
  </table>
  </div>
  <div style="height: 40px;"></div>
  </div>
} <!-- close  @if (cohortData(); as cohort){ -->


<div class="flex items-center gap-4 p-2 bg-slate-50 rounded-xl shadow-sm border border-slate-200">
  
  <div class="flex items-center gap-2 pl-2 flex-grow">
    <div class="w-full max-w-md">
      <app-hpoautocomplete #hpoSearch></app-hpoautocomplete>
    </div>
    <button 
      mat-flat-button 
      color="primary"
      [disabled]="hpoSearch.control.invalid" 
      (click)="submitSelectedHpo(hpoSearch.control.value)"
      class="btn-outline-primary">
      Submit
    </button>
  </div>

  <div class="h-8 w-[1px] bg-slate-200"></div>

  <div class="flex items-center gap-3 pr-2">
    
    <div class="flex items-center bg-white border border-slate-200 rounded-lg p-0.5 shadow-sm">
      <button mat-button (click)="openAgeDialog()" class="!h-8 !px-3 !text-sm hover:bg-slate-50">
        <mat-icon class="scale-75 !m-0">edit</mat-icon>
        <span class="ml-1">Add onset age</span>
      </button>
      <div class="w-[1px] h-4 bg-slate-200"></div>
      <button mat-button (click)="addAllCohortAges()" class="!h-8 !px-3 !text-sm !text-slate-600 hover:bg-slate-50">
        <mat-icon class="scale-75 !m-0">group_add</mat-icon>
        <span class="ml-1">Add ages from cohort</span>
      </button>
    </div>

    @if (ageEntries().length > 0) {
      <div class="flex items-center gap-2 h-8 px-3 bg-emerald-50 border border-emerald-100 rounded-full">
        <span class="text-[10px] font-bold uppercase text-emerald-600">Latest:</span>
        <span class="text-xs font-medium text-emerald-800">{{ ageEntries().at(-1) }}</span>
        <span class="text-[10px] text-emerald-400 bg-emerald-100/50 px-1.5 rounded-full">{{ ageEntries().length }}</span>
      </div>
    }

    <app-help-button 
      title="Managing age data"
      [lines]="[
        'Right-click HPO cells to add specific onset ages.',
        'Format examples: <b>Congenital onset</b>, <b>P3Y2M</b>, or <b>G28w1d</b>.',
        'Use <i>Cohort</i> to pull all ages existing in current data.'
      ]" />
  </div>
</div>


<div class="flex items-center flex-wrap gap-3 p-3 bg-white rounded-lg shadow-sm border border-gray-200 mb-4">
  
  <div class="flex items-center gap-2 border-r pr-3 border-gray-300">
     <a routerLink="/addcase" class="tool-btn btn-workflow no-underline">
          Add Phenopacket
        </a>
    
    <div class="action-with-help">
      <a routerLink="/tableeditor" class="tool-btn btn-workflow no-underline">
      <mat-icon>table_chart</mat-icon> New ETL
    </a>
      <app-help-button 
        title="Adding additional data" 
        [lines]="[
          '<b>New Case:</b> Add a new individual (e.g., case report).',
          '<b>New ETL:</b> Add ETL cohort'
        ]" 
        helpUrl="https://p2gx.github.io/phenoboard/help/cohort-editor.html"
      />
    </div>
  </div>

  <div class="flex items-center gap-2 border-r pr-3 border-gray-300">
    <button class="tool-btn btn-workflow" (click)="validateCohort()">
      <mat-icon>health_and_safety</mat-icon> Check & Fix
    </button>

    <div class="action-with-help">
      <button class="tool-btn btn-workflow" (click)="sortCohortRows()" matTooltip="Sort rows chronologically">
        <mat-icon>sort</mat-icon> Sort
      </button>
      <app-help-button 
        title="Editing cohort data" 
        [lines]="[
          '<b>Check & Fix:</b> Validate data (and offer chance to fix if desired).',
          '<b>Sort rows:</b> Sort rows of cohort chronologically according to PMID'
        ]" 
        helpUrl="https://p2gx.github.io/phenoboard/help/cohort-editor.html"
      />
    </div>
  </div>

  <div class="flex items-center gap-2">
    <button class="tool-btn btn-success" (click)="saveCohort()">
      <mat-icon>save</mat-icon> Save
    </button>
    
    <button class="tool-btn btn-success" (click)="exportPpkt()">
      <mat-icon>description</mat-icon> Phenopackets
    </button>

    <button class="tool-btn btn-success" (click)="exportHpoa()">
      <mat-icon>assignment</mat-icon> HPOA
    </button>

    <button class="tool-btn btn-warning" (click)="recordBiocuration()">
      <mat-icon>fingerprint</mat-icon> Biocuration
    </button>

    <app-help-button 
      title="Cohort Action Guide"
      [lines]="[
        '<b>Save:</b> Saves current cohort as JSON file.',
         '<b>Phenopackets:</b> Exports current cohort as collection of phenopacket files.',
         '<b>HPOA:</b> Exports current cohort as an HPO annotation file.',
        '<b>Biocuration:</b>Adds current ORCID id to the cohort file.',
       
      ]" 
      helpUrl="https://p2gx.github.io/phenoboard/help/cohort-editor.html"
    />
  </div>

</div>
</div>

<!-- Context Menu (appears after right-click on HPO cell)-->
@if (contextMenuVisible) {
  <div
    [ngStyle]="{ top: contextMenuY + 'px', left: contextMenuX + 'px' }"
    class="absolute z-50 bg-white border border-gray-300 rounded-lg shadow-md p-2 text-sm w-44"
    role="menu"
    aria-label="Annotation context menu"
    #contextMenu
  >
    @for (option of contextMenuOptions; track option) {
      <button
        class="block w-full text-left px-3 py-2 rounded-md hover:bg-gray-100 focus:outline-none focus:bg-gray-200 transition"
        role="menuitem"
        (click)="onMenuOptionClick(option.value)"
        type="button"
      >
        {{ option.label }}
      </button>
    }
  </div>
}
<!-- Individual (row-level) context menu -->
 @if (individualContextMenuVisible) {
  <div
    class="absolute bg-white border border-gray-300 rounded shadow-md z-50 text-sm"
    [style.left.px]="individualMenuX"
    [style.top.px]="individualMenuY"
    #individualContextMenu
  >
    <ul>
      <li class="px-3 py-1 cursor-pointer hover:bg-gray-100"
          (click)="focusOnSingleRow()">Focus on row</li>
      <li class="px-3 py-1 cursor-pointer hover:bg-gray-100"
          (click)="focusOnPmid(contextRowPmid)">Focus on PMID: {{ contextRowPmid ?? 'N/A' }}</li>
      <li class="px-3 py-1 cursor-pointer hover:bg-gray-100 text-blue-600 flex justify-between items-center"
      (click)="openPmidInBrowser(contextRowPmid)"> Open PMID in Browser<span class="text-xs">‚Üó</span>
      </li>
      <li class="px-3 py-1 cursor-pointer hover:bg-gray-100"
          (click)="showAllRows()">Show all rows</li>
      <li class="px-3 py-1 cursor-pointer hover:bg-gray-100"
          (click)="showInfoForRow(contextRowId, $event)">Show info</li>
      <li class="px-3 py-1 cursor-pointer border border-red-500 rounded"
          (click)="deleteRow(contextRowId)">Delete row</li>
    </ul>
  </div>
}
