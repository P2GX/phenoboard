@let cohort = cohortDto;

<div class="p-6 bg-gray-50">
  @if (cohortDescription) {
    <div class="text-sm text-gray-700 space-y-2">
      <h2 class="text-xl font-semibold text-gray-800">
        {{ cohortDescription.diseaseLabel }} (<i>{{ cohortDescription.geneSymbol }}</i>)
      </h2>

      <p>
        This is a <strong>{{ cohortDescription.cohortType }}</strong> cohort with 
        <strong>{{ cohortDescription.numIndividuals }}</strong> individuals and 
        <strong>{{ cohortDescription.numHpos }}</strong> distinct HPO terms.
        Most individuals are diagnosed with 

      @if (cohortDescription.diseaseDatabase == "OMIM") {
        <a [href]="'https://omim.org/entry/' + getOmimId(cohortDescription.diseaseId)" 
           target="_blank" class="text-blue-600 underline">
          {{ cohortDescription.diseaseLabel }} ({{ cohortDescription.diseaseId }})
        </a>
      } @else {
        <span>
          {{ cohortDescription.diseaseLabel }} ({{ cohortDescription.diseaseId }})
        </span>,
      } associated with 
        <a [href]="'https://www.genenames.org/data/gene-symbol-report/#!/hgnc_id/' + cohortDescription.hgncId" 
           target="_blank" class="text-blue-600 underline">
          {{ cohortDescription.geneSymbol }} ({{ cohortDescription.hgncId }}),
        </a>
        transcript <code>{{ cohortDescription.transcript }}</code>.
      </p>
    </div>
  } @else {
    <p class="error-message">Cohort not initialized.</p>
  }

  <!-- String input section -->
  <div class="mt-4">
    @if (!showCohortAcronym) {
      <button 
        (click)="showCohortAcronym = true"
        class="btn-outline-primary"
      >
       Set cohort acronym
      </button>
    } @else {
      <div class="flex gap-2 items-center">
        <input 
          #acronymInput
          type="text" 
          placeholder="Enter cohort acronym..."
          class="px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 flex-1"
          (keyup.enter)="submitCohortAcronym(acronymInput.value)"
        />
        <button 
          (click)="submitCohortAcronym(acronymInput.value)"
          class="btn-outline-primary"
        >
          Submit
        </button>
        <button 
          (click)="cancelCohortAcronym()"
          class="btn-outline-cancel"
        >
          Cancel
        </button>
      </div>
    }
    @if (cohort) {
       <p class="text-sm text-gray-500">{{ cohort.cohortAcronym != "na" ? cohort.cohortAcronym : "not initialized" }}</p>
    }
   
  </div>

</div> 

  <!-- Table with one row per phenopacket -->
  @if (cohort){
  <table class="pt-table">
    <thead>
    <tr>
      <th class="narrow-column bottom-align">Individual ID</th>
      <th class="narrow-column bottom-align">Disease</th>
      <th class="narrow-column bottom-align">Gene</th>
      <!-- The following creates the series of headers for the HPO columns.
          The function shouldDisplayHpoColumn allows the user to focus on 1-10 columns at a time-->
      @if (cohort) {
          @for (header of cohort.hpoHeaders; track $index) {
           @if(shouldDisplayHpoColumn($index)) {
              <th
                class="rotate-header hpo-col"
                (mouseenter)="setHover('hpoHeader', 0, $index, true)"
                (mouseleave)="setHover('hpoHeader', 0, $index, false)"
              >
                <div class="rotated-text" [ngClass]="{ 'hover-underline': true }">
                  {{ header.hpoLabel }}
                </div>
              <!-- Popup shown on hover -->
              @if(isHovered('hpoHeader', 0, $index)) {
                  <div class="hpo-popup">
                    <a
                      [href]="'https://hpo.jax.org/browse/term/' + header.hpoId"
                      target="_blank"
                      rel="noopener"
                    >
                      üîó {{ header.hpoId }}
                    </a>
                  </div>
                }
              </th>
            }
          }
        }
  </tr>
  </thead>
    <tbody>
      @for (row of cohort.rows; track row; let rowIndex = $index) {
      <tr>
        <!-- First column: PMID/title/individual_id/comment -->
        <td class="relative narrow-column">
        <div 
            (mouseenter)="setHover('individual', rowIndex, 0, true)"
            (mouseleave)="setHover('individual', rowIndex, 0, false)"
          class="cursor-pointer"
        >
          {{ row.individualDto.individualId }}
          @if(!row.individualDto.individualId){
            <span class="text-red-500 text-xs">[ID is null/empty] row={{row}}</span>
          }
          @if(isHovered('individual', rowIndex, 0)){
            <div
              class="absolute top-0 left-0 ml-2 bg-white shadow-md border p-2 rounded z-50 w-64"
                (mouseenter)="setHover('individual', rowIndex, 0, true)"
                (mouseleave)="setHover('individual', rowIndex, 0, false)"
            >
            <ul class="list-disc list-inside text-sm text-gray-800 mb-2">
              <li><strong>{{ row.individualDto.individualId }}</strong></li>
              <li>{{ row.individualDto.pmid }}</li>
              <li>{{ row.individualDto.title }}</li>
              @if(row.individualDto.comment.length > 0){
                <li><strong>Comment:</strong> {{ row.individualDto.comment }}</li>
              }
              <li>onset: {{ row.individualDto.ageOfOnset }}</li>
              <li>last encounter: {{ row.individualDto.ageAtLastEncounter }}</li>
              <li>deceased: {{ row.individualDto.deceased }}</li>
              <li>sex: {{ row.individualDto.sex }}</li>
            </ul>
            <!-- Edit button in popup -->
            <button
              mat-stroked-button
              color="primary"
              class="text-xs py-0 px-2"
              (click)="openIndividualEditor(row.individualDto); $event.stopPropagation();"
            >
              ‚úèÔ∏è Edit
            </button>
          </div>
        }
      </div>
    </td>

<!-- Second column: disease/id -->
<td class="relative narrow-column">
  @for (disease of row.diseaseDtoList; track $index; let di = $index) {
    <div
      class="relative inline-block"
      (mouseenter)="setHover('disease', rowIndex, di, true)"
      (mouseleave)="setHover('disease', rowIndex, di, false)"
    >
      <span class="cursor-pointer">{{ disease.diseaseId }}</span>
      @if(isHovered('disease', rowIndex, di)) {
        <div
          class="absolute top-0 left-full -ml-4 bg-white shadow-md border p-2 rounded z-50 w-64"
          (mouseenter)="setHover('disease', rowIndex, di, true)"
          (mouseleave)="setHover('disease', rowIndex, di, false)"
        >
           <ul class="list-disc list-inside text-sm text-gray-800 mb-2">
              <li><strong>{{ disease.diseaseId }}</strong></li>
              <li>{{ disease.diseaseLabel }}</li>
            </ul>
            <!-- Edit button in popup -->
            <button
              mat-stroked-button
              color="primary"
              class="text-xs py-0 px-2"
              (click)="openDiseaseEditor(disease); $event.stopPropagation();"
            >
              ‚úèÔ∏è Edit
            </button>
          </div>
      }
    </div>
  }
</td>

 <!-- Third column for gene/var-->
  <!-- Third column for gene/allele -->
<td class="relative narrow-column">
  @for (entry of Object.entries(row.alleleCountMap); track $index; let gi = $index) {
    <div
      class="relative inline-block"
      (mouseenter)="setHover('gene', rowIndex, gi, true)"
      (mouseleave)="setHover('gene', rowIndex, gi, false)"
    >
      <!-- Display gene symbol / allele key -->
      <span class="cursor-pointer">{{ getShortAlleleDisplay(entry[0], entry[1]) }}</span>

      @if (isHovered('gene', rowIndex, gi)) {
        <div
          class="absolute top-0 left-full -ml-4 bg-white shadow-md border p-2 rounded z-50 w-64 break-words"
          (mouseenter)="setHover('gene', rowIndex, gi, true)"
          (mouseleave)="setHover('gene', rowIndex, gi, false)"
        >
         <ul class="list-disc list-inside text-sm text-gray-800 break-words">
            @for (displayString of getAlleleDisplay(entry[0], entry[1]); track $index) {
              <li>{{ displayString }}</li>
            }
          </ul>

          <!-- <button
            mat-stroked-button
            color="primary"
            class="text-xs py-0 px-2"
            (click)="openAlleleEditor(alleleKey); $event.stopPropagation();"
          >
            ‚úèÔ∏è Edit
          </button> -->
        </div>
      }
    </div>
  }
</td>

<!-- The values of the HPO columns-->
    @for (cell of row.hpoData; track i; let i = $index) {
      @if(shouldDisplayHpoColumn(i)) {
      <td
        class="hpo-col"
        (contextmenu)="onRightClick($event, i, rowIndex, cell)"
        [class.observed-cell]="cell.type=='Observed'"
        [class.excluded-cell]="cell.type=='Excluded'"
        [class.na-cell]="cell.type=='Na'"
      >
        @switch (cell.type) {
          @case ('Observed') {  ‚úÖ. }
          @case ('Excluded') {  ‚ùå  }
          @case ('Na') { n/a }
          @case ('OnsetAge') {
            <div
              class="truncate max-w-[4rem] overflow-hidden whitespace-nowrap"
              [title]="cell.data"
            >
              {{ cell.data }}
            </div>
          }
          @case ('Modifier') {
            <div
              class="truncate max-w-[4rem] overflow-hidden whitespace-nowrap"
              [title]="cell.data"
            >
              {{ cell.data }}
            </div>
          }
          @default {
            <span>Unknown</span>
          }
        }
      </td>
      }
    }

  } <!-- end of for over the tr -->
    </tbody>
  </table>
} <!-- close  @if (cohort){ -->


  <!-- Toolbar / Controls -->
<div class="flex items-center gap-6 p-4 bg-white rounded-lg shadow-sm border border-gray-200">
  <!-- HPO Autocomplete -->
  <div class="flex flex-col ">
    <label class="text-xs font-medium text-gray-600 mb-1">Add HPO Term</label>
    <app-hpoautocomplete
      [inputString]="hpoInputString"
      (selected)="selectedHpoTerm = $event"
      [onSubmit]="submitSelectedHpo"
      #hpoAutocomplete
      class="w-full"
    ></app-hpoautocomplete>
  </div>

  <!-- Add Ages -->
  <div class="flex flex-col">
    <label class="text-xs font-medium text-gray-600 mb-1">Add Onset</label>
    <app-addages #addagesComponent class="w-full"></app-addages>
  </div>

  <!-- Actions -->
  <div class="flex items-center gap-3 ml-auto">
    <button 
      (click)="validateCohort()" 
      class="px-4 py-2 text-sm rounded-lg border border-blue-600 text-blue-600 hover:bg-blue-50 transition"
    >
      Validate
    </button>
    <button 
      (click)="saveCohort()" 
      class="px-4 py-2 text-sm rounded-lg border border-green-600 text-green-600 hover:bg-green-50 transition"
    >
      Save
    </button>
    <button 
      (click)="exportPpkt()" 
      class="px-4 py-2 text-sm rounded-lg border border-purple-600 text-purple-600 hover:bg-purple-50 transition"
    >
      Export phenopackets
    </button>
     <button 
      (click)="exportHpoa()" 
      class="px-4 py-2 text-sm rounded-lg border border-purple-600 text-purple-600 hover:bg-pink-50 transition"
    >
      Export Hpoa
    </button>
  </div>
</div>

<!-- Context Menu -->
@if (contextMenuVisible) {
  <div
    [ngStyle]="{ top: contextMenuY + 'px', left: contextMenuX + 'px' }"
    class="absolute z-50 bg-white border border-gray-300 rounded-lg shadow-md p-2 text-sm w-44"
    role="menu"
    aria-label="Annotation context menu"
  >
    @for (option of contextMenuOptions; track option) {
      <button
        class="block w-full text-left px-3 py-2 rounded-md hover:bg-gray-100 focus:outline-none focus:bg-gray-200 transition"
        role="menuitem"
        (click)="onMenuOptionClick(option.value)"
        type="button"
      >
        {{ option.label }}
      </button>
    }
  </div>
}

