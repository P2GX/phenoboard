<h2 mat-dialog-title class="flex justify-between items-center">
  <span>Review Mapping: <span class="text-blue-600">{{ title }}</span></span>
  <mat-chip class="text-sm">Found {{ concepts.length }} unique terms</mat-chip>
</h2>

<mat-dialog-content class="mat-typography">
  <div class="review-table-container border rounded-lg overflow-hidden shadow-sm">
    <table mat-table [dataSource]="concepts" class="w-full">
      
      <ng-container matColumnDef="source">
        <th mat-header-cell *matHeaderCellDef> Source Fragment </th>
        <td mat-cell *matCellDef="let c">
          <div class="flex items-center gap-2">
            <mat-icon class="text-gray-400 scale-75">description</mat-icon>
            <code class="text-sm font-medium text-gray-700 bg-gray-100 px-2 py-1 rounded">
              "{{ c.originalText }}"
            </code>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="mapping">
        <th mat-header-cell *matHeaderCellDef> HPO Mappings </th>
        <td mat-cell *matCellDef="let c; let i = index">
          <div class="flex flex-wrap gap-2 items-center min-h-[48px] py-1">
            @for (term of c.suggestedTerms; track term.id; let termIdx = $index) {
              <mat-chip-row 
                class="hpo-chip animate-in fade-in zoom-in duration-200"
                (removed)="removeTerm(i, termIdx)">
                <span class="font-mono font-bold mr-1 opacity-70">{{ term.id }}</span>
                <span>{{ term.label }}</span>
                <button matChipRemove><mat-icon>cancel</mat-icon></button>
              </mat-chip-row>
            }

            @if (searchingIndices.has(i) || c.suggestedTerms.length === 0) {
              <div class="flex-grow min-w-[250px] transition-all">
                <app-hpoautocomplete 
                  (selected)="addNewTerm(i, $event)"
                  (blur)="onBlur(i)">
                </app-hpoautocomplete>
              </div>
            } @else {
              <button mat-icon-button color="primary" 
                      class="hover:bg-blue-50 transition-colors"
                      (click)="startSearch(i)" 
                      matTooltip="Add another HPO term">
                <mat-icon>add_circle_outline</mat-icon>
              </button>
            }
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef> Status </th>
        <td mat-cell *matCellDef="let c; let i = index">
          <mat-button-toggle-group 
            [(ngModel)]="c.clinicalStatus" 
            [name]="'status-' + i"
            class="status-toggle">
            <mat-button-toggle value="observed">Observed</mat-button-toggle>
            <mat-button-toggle value="excluded">Excluded</mat-button-toggle>
          </mat-button-toggle-group>
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef> Action </th>
        <td mat-cell *matCellDef="let c; let i = index">
          <div class="flex items-center gap-1">
             <button mat-icon-button 
                    [color]="c.miningStatus === 'confirmed' ? 'primary' : ''" 
                    (click)="toggleConfirm(i)"
                    [matTooltip]="c.miningStatus === 'confirmed' ? 'Unconfirm' : 'Confirm mapping'">
              <mat-icon>{{ c.miningStatus === 'confirmed' ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="removeConcept(i)" matTooltip="Ignore this fragment">
              <mat-icon>delete_outline</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="['source', 'mapping', 'status', 'actions']" class="bg-gray-50"></tr>
      <tr mat-row 
          *matRowDef="let row; columns: ['source', 'mapping', 'status', 'actions'];"
          [class.is-confirmed]="row.miningStatus === 'confirmed'"
          class="hover:bg-blue-50/30 transition-colors border-b last:border-0">
      </tr>
    </table>
  </div>
</mat-dialog-content>

<mat-dialog-actions align="end" class="p-4 border-t bg-gray-50">
  <button mat-button (click)="cancel()">Discard Changes</button>
  <button mat-raised-button color="primary" (click)="save()" [disabled]="concepts.length === 0">
    <mat-icon class="mr-1">done_all</mat-icon>
    Apply {{ concepts.length }} Mappings
  </button>
</mat-dialog-actions>