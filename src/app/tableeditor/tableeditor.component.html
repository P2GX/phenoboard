<div class="primary-box">
<h1 class="h1-primary">External Table Editor</h1>
  <p class="text-xs">Ingest external tables (e.g., Supplemental Files with information about cohorts) by transforming the table column by column. You can save and load the external templates to continue work later. In general, however, these json files should not be stored long-term (or checked into GitHub).</p>
</div>
<div class="button-row">
  <button 
    class="btn-outline-primary"
    (click)="loadExcel()">
    Load External Excel File (Column-based)
  </button>

  <button 
    class="btn-outline-primary"
    (click)="loadExcelRowBased()">
    Load External Excel File (Row-based)
  </button>

  <button 
    class="btn-outline-primary"
    (click)="saveExternalTemplateJson()">
    Save External Template JSON
  </button>

  <button 
    class="btn-outline-primary"
    (click)="loadExternalTemplateJson()">
    Load External Template JSON
  </button>
</div>


<div class="error-container" *ngIf="errorMessage">
  <div class="error-message">
    {{ errorMessage }}
  </div>
</div>
<div *ngIf="!externalTable">
  <p>No table loaded yet.</p>
</div>


<table class="pt-table">
  <ng-container *ngFor="let row of displayRows; let rowIndex = index">
    <tr [ngClass]="{
          'header-row': rowIndex === 0,
          'type-row': rowIndex === 1
        }">
      <ng-container *ngFor="let colIndex of getVisibleColumns(row)">
        <td
          [ngClass]="{
            'edit-mode-narrow': editModeActive
          }"
          [ngStyle]="{
            'background-color': colIndex === 0
              ? '#f0f8ff'
              : isTransformedColumn(colIndex)
                ? '#e6ffe6'
                : colIndex === visibleColIndex
                  ? '#fffbe6'
                  : 'transparent'
          }"
          (contextmenu)="rowIndex === 0
              ? onRightClickHeader($event, colIndex)
              : onRightClickCell($event, rowIndex, colIndex)"
        >
          {{ row[colIndex] }}
        </td>
      </ng-container>
    </tr>
  </ng-container>
</table>


<!-- Context menu for column headers -->
<div
  *ngIf="columnContextMenuVisible"
  [style.top.px]="columnContextMenuY"
  [style.left.px]="columnContextMenuX"
  class="context-menu"
  (click)="columnContextMenuVisible = false"
>
  <div style="padding: 5px 12px; font-weight: bold;">
    Column: {{ contextMenuColHeader }}<br />
    Type: {{ contextMenuColType }}
  </div>
  <ul>
    <li *ngIf="contextMenuColIndex !== null" (click)="startEditColumn(contextMenuColIndex)">Edit Column</li>
    <li (click)="applyTransform(contextMenuColIndex)">Transform Column</li>
    <li *ngIf="contextMenuColIndex !== null" (click)="editUniqueValuesInColumn(contextMenuColIndex)">Replace Unique Values</li>
    <li (click)="showOnlyColumn(contextMenuColIndex)">Show Only This Column</li>
    <li (click)="clearColumnFilter()">Show All Columns</li>
    <!-- Submenu -->
    <li class="has-submenu">
      Set Column Type ▸
      <ul class="submenu">
        <li *ngFor="let type of etlTypes" (click)="assignColumnType(type)">
          {{ type }}
        </li>
      </ul>
    </li>
    <li (click)="deleteColumn(contextMenuColIndex)">Delete Column</li>
    <li (click)="applyIso8601AgeTransform()">Convert Ages to ISO8601</li>
  </ul>
</div>

<div
  *ngIf="contextMenuCellVisible"
  class="context-menu"
  [style.top.px]="contextMenuCellX"
  [style.left.px]="contextMenuCellY"
  (click)="contextMenuCellVisible = false"
>
  <div style="padding: 5px 12px; font-weight: bold;">
    Value: "{{ contextMenuCellValue }}"<br />
    Type: {{ contextMenuCellType }}
  </div>
  <ul>
    <li (click)="editValueManually()">Edit Value...</li>
  </ul>
</div>


<div 
  *ngIf="transformationPanelVisible"
  class="transformation-panel"
>
  <h3>Transform values in column: {{ contextMenuColHeader }}</h3>
  <div *ngFor="let val of uniqueValuesToMap" class="transform-row">
    <label>
      {{ val }} →
      <input [(ngModel)]="transformationMap[val]" class="transform-input" />
    </label>
  </div>
  <button (click)="applyValueTransform()">Apply Transformation</button>
</div>
<div *ngIf="editPreviewColumnVisible" class="confirm-transform-box">
  <button (click)="confirmValueTransformation()">✅ Confirm Transformation</button>
  <button (click)="cancelTransformation()">❌ Cancel</button>
</div>
