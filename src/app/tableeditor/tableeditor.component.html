<div class="primary-box">
<h1 class="h1-primary">External Table Editor</h1>
  <p class="text-xs">Ingest external tables (e.g., Supplemental Files with information about cohorts) by transforming the table column by column. You can save and load the external templates to continue work later. In general, however, these JSON files should not be stored long-term (or checked into GitHub).</p>
</div>
<div class="button-row">
  <button 
    class="btn-outline-primary"
    (click)="loadExcelColumnBased()">
    Load Excel File (Columns)
  </button>

  <button 
    class="btn-outline-primary"
    (click)="loadExcelRowBased()">
    Load Excel File (Rows)
  </button>

  <button 
    class="btn-outline-primary"
    (click)="saveExternalTemplateJson()">
    Save ETL JSON
  </button>

  <button 
    class="btn-outline-primary"
    (click)="loadExternalTemplateJson()">
    Load ETL JSON
  </button>

    <button 
    class="btn-outline-primary"
    (click)="importCohortDiseaseData()">
    Import cohort disease data
  </button>

  <button (click)="openPubmedDialog()" class="btn-outline-primary">üîç Lookup PubMed</button>
  <button (click)="addToCohortData()" class="btn-outline-primary">Add data to cohort</button>
</div>

@if (errorMessage) {
  <div class="error-container">
    <div class="error-message">
      {{ errorMessage }}
    </div>
  </div>
}
@if (!etlDto?.table) {
  <div>
    <p>No table loaded yet.</p>
  </div>
}

@if(etlDto) {
<div class="pt-table-container">
<table class="pt-table">
   <!-- ===== HEADER ROW ===== -->
  <tr class="header-row">
    @for (colIndex of getVisibleColumns(); track etlDto.table.columns[colIndex].id) {
      @let col = etlDto.table.columns[colIndex];
      <th [ngClass]="getColumnClass(colIndex)"
      (contextmenu)="onRightClickHeader($event, colIndex)">
        <span [matTooltip]="col.header.current || ''">
          {{ col.header.original }}
        </span>
      </th>
    }
  </tr>

  <!-- ===== TYPE ROW ===== -->
  <tr class="type-row">
     @for (colIndex of getVisibleColumns(); track etlDto.table.columns[colIndex].id) {
        @let col = etlDto.table.columns[colIndex];
      <th class="border border-gray-400 px-2 py-1 text-center text-sm text-gray-600">
        {{ col.header.columnType }}
      </th>
    }
  </tr>

  <!-- ===== DATA ROWS ===== -->
@for (row of displayRows; track trackRow($index, row); let rowIndex = $index) {
  <tr>
    
    @for (colIndex of getVisibleColumns(); track etlDto.table.columns[colIndex].id) {
      <td
        [ngClass]="{
          'edit-mode-narrow': editModeActive
        }"
        (contextmenu)="onRightClickCell($event, rowIndex, colIndex)"
      >
          <div 
            class="table-cell" 
            [matTooltip]="row[colIndex]"
            matTooltipClass="custom-tooltip"
            matTooltipPosition="above"
            matTooltipShowDelay="300"
          >
            {{ row[colIndex] }}
          </div>
          
        </td>
      }
    </tr>
  }

</table>
<div style="height: 40px;"></div>
</div>
}

<!-- Context menu for column headers -->
 @if (columnContextMenuVisible) {
<div
  [style.top.px]="columnContextMenuY"
  [style.left.px]="columnContextMenuX"
  class="context-menu"
  (click)="columnContextMenuVisible = false"
>
  <div style="padding: 5px 12px; font-weight: bold;">
    Column: {{ contextMenuColHeader }}<br />
    Type: {{ contextMenuColType }}
  </div>
  <ul>
    @if(contextMenuColIndex !== null){<li (click)="startEditColumn(contextMenuColIndex)">Focus on Column</li>}
     <li (click)="clearColumnFilter()">Show All Columns</li>
    <li class="has-submenu">
  Transform Column ‚ñ∏
  <ul class="submenu">
    @for (category of Object.values(transformCategories); track category.label) {
      <li class="has-submenu">
        {{ category.label }} ‚ñ∏
        <ul class="submenu">
          @for (transform of category.transforms; track transform) {
            <li (click)="applyNamedTransform(contextMenuColIndex, transform)">
              {{ getTransformDisplayName(transform) }}
            </li>
          }
        </ul>
      </li>
    }
  </ul>
</li>
  </ul>
</div>
}
  @if (contextMenuCellVisible) {
    <div class="context-menu-visible"
        [style.top.px]="contextMenuCellY" 
        [style.left.px]="contextMenuCellX"
        (click)="contextMenuCellVisible = false"
    >
      <div style="padding: 5px 0; font-weight: bold;">
        Value: "{{ contextMenuCellValue }}"<br />
        Type: {{ contextMenuCellType }}
      </div>
      <ul style="margin: 8px 0 0 0; padding: 0; list-style: none;">
        <li
          style="padding: 4px 8px; cursor: pointer;"
          (click)="editCellValueManually()"
        >
           <mat-icon>edit</mat-icon> Edit cell contents
        </li>
       @if (hasValueAbove()) {
          <li (click)="useValueFromAbove()">
            <mat-icon>content_copy</mat-icon> Copy value from above
          </li>
        }
        <li
          style="padding: 4px 8px; cursor: pointer;"
          (click)="openHgvsEditor()"
        >
           <mat-icon>science</mat-icon>Manually add HGVS
        </li>
         <li
          style="padding: 4px 8px; cursor: pointer;"
          (click)="openSvEditor()"
        >
           <mat-icon>account_tree</mat-icon>Manually add Structural Variant
        </li>
      </ul>
    </div>
  }
@if (transformationPanelVisible) {
  <div class="transformation-panel">
    <h3>Transform values in column: {{ contextMenuColHeader }}</h3>
    <div *ngFor="let val of uniqueValuesToMap" class="transform-row">
      <label>
        {{ val }} ‚Üí
        <input [(ngModel)]="transformationMap[val]" class="transform-input" />
      </label>
    </div>
    <button (click)="applyValueTransform()" class="btn-outline-primary">‚úÖ Apply Transformation</button>
    <button (click)="cancelTransformation()" class="btn-outline-primary">‚ùå Cancel</button>
  </div>
}

@if(editPreviewColumnVisible){
  <div class="confirm-transform-box">
    <button (click)="confirmValueTransformation()">‚úÖ Confirm Transformation</button>
    <button (click)="cancelTransformation()">‚ùå Cancel</button>
  </div>
}

@if(editModalVisible) {
<div class="edit-modal">
  <h4><strong>Edit Cell Value</strong>:</h4>
  <input
    [(ngModel)]="editingValue"
    style="
      width: 100%;
      margin-top: 10px;
      padding: 6px 10px;
      border: 2px solid #007acc;
      border-radius: 4px;
      font-size: 14px;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    "
  />
  <div style="margin-top: 16px; text-align: right;">
    <button (click)="saveManualEdit()">Save</button>
    <button (click)="editModalVisible = false" style="margin-left: 8px;">Cancel</button>
  </div>
</div>
}
@if (previewModalVisible) {
<div class="preview-modal">
  <h3>Preview: {{ previewTransformName }} on Column</h3>
  <div class="scrollable-table-container">
    <table style="width: 100%; border-collapse: collapse; margin-top: 12px;">
      <thead>
        <tr>
          <th style="text-align: left; border-bottom: 1px solid #ccc;">Original</th>
          <th style="text-align: left; border-bottom: 1px solid #ccc;">Transformed</th>
        </tr>
      </thead>
      <tbody>
        @for (orig of previewOriginal; track i; let i=$index) {
          <tr>
            <td style="padding: 4px; border-bottom: 1px solid #eee;">{{ orig }}</td>
            <td style="padding: 4px; border-bottom: 1px solid #eee;">{{ previewTransformed[i] }}</td>
          </tr>
        }
      </tbody>
    </table>
  </div>
  <div style="text-align: right; margin-top: 16px; display: flex; justify-content: flex-end; gap: 8px;">
    <button (click)="applyTransformConfirmed()">‚úÖ Apply</button>
    <button (click)="cancelValueTransformation()">Cancel</button>
  </div>
</div>
}