<div class="primary-box">
<h1 class="h1-primary">External Table Editor</h1>
  <p class="text-xs">Ingest external tables (e.g., Supplemental Files with information about cohorts) by transforming the table column by column. You can save and load the external templates to continue work later. In general, however, these JSON files should not be stored long-term (or checked into GitHub).</p>
</div>
<div class="button-row">
  <button 
    class="btn-outline-primary"
    (click)="loadExcelColumnBased()">
    Load External Excel File (Column-based)
  </button>

  <button 
    class="btn-outline-primary"
    (click)="loadExcelRowBased()">
    Load External Excel File (Row-based)
  </button>

  <button 
    class="btn-outline-primary"
    (click)="saveExternalTemplateJson()">
    Save External Template JSON
  </button>

  <button 
    class="btn-outline-primary"
    (click)="loadExternalTemplateJson()">
    Load External Template JSON
  </button>
</div>

@if (errorMessage) {
  <div class="error-container">
    <div class="error-message">
      {{ errorMessage }}
    </div>
  </div>
}
@if (!etlDto?.table) {
  <div>
    <p>No table loaded yet.</p>
  </div>
}

<div class="pt-table-container">
<table class="pt-table">
   <!-- ===== HEADER ROW ===== -->
  <tr class="header-row">
    @for (col of displayColumns; track col.id; let colIndex = $index) {
      <th [ngClass]="getColumnClass(colIndex)"
      (contextmenu)="onRightClickHeader($event, colIndex)">
        <span [matTooltip]="col.header.current || ''">
          {{ col.header.original }}
        </span>
      </th>
    }
  </tr>

  <!-- ===== TYPE ROW ===== -->
  <tr class="type-row">
    @for (col of displayColumns; track col.id) {
      <th class="border border-gray-400 px-2 py-1 text-center text-sm text-gray-600">
        {{ col.header.columnType }}
      </th>
    }
  </tr>

  <!-- ===== DATA ROWS ===== -->
@for (row of displayRows; track row; let rowIndex = $index) {
  <tr>
    
    @for (colIndex of getVisibleColumns(row); track displayColumns[colIndex]?.id || colIndex) {
      <td
        [ngClass]="{
          'edit-mode-narrow': editModeActive
        }"
        (contextmenu)="onRightClickCell($event, rowIndex, colIndex)"
      >
          <div 
            class="table-cell" 
            [matTooltip]="row[colIndex]"
            matTooltipClass="custom-tooltip"
            matTooltipPosition="above"
            matTooltipShowDelay="300"
          >
            {{ row[colIndex] }}
          </div>
          
        </td>
      }
    </tr>
  }

</table>
<div style="height: 40px;"></div>
</div>

<!-- Context menu for column headers -->
 @if (columnContextMenuVisible) {
<div
  [style.top.px]="columnContextMenuY"
  [style.left.px]="columnContextMenuX"
  class="context-menu"
  (click)="columnContextMenuVisible = false"
>
  <div style="padding: 5px 12px; font-weight: bold;">
    Column: {{ contextMenuColHeader }}<br />
    Type: {{ contextMenuColType }}
  </div>
  <ul>
    @if(contextMenuColIndex !== null){<li (click)="startEditColumn(contextMenuColIndex)">Edit Column</li>}
    @if(contextMenuColIndex !== null){<li (click)="hpoAutoForColumnName(contextMenuColIndex)">Edit Column Name (HPO)</li> }
    @if(contextMenuColIndex !== null){<li (click)="hpoMultipleForColumnName(contextMenuColIndex)">Edit Multiple HPO Column</li> }
    <li class="has-submenu">
      Transform Column ▸
      <ul class="submenu">
        @for(transform of transformOptions; track transform){
          <li (click)="applyNamedTransform(contextMenuColIndex, transform)" >
            {{ transform }}
          </li>
        }
      </ul>
    </li>
    @if(contextMenuColIndex !== null){<li (click)="editUniqueValuesInColumn(contextMenuColIndex)">Replace Unique Values</li>}
    <li (click)="clearColumnFilter()">Show All Columns</li>
    <!-- Submenu -->
    <li class="has-submenu">
      Set Column Type ▸
      <ul class="submenu">
        @for( type of etlTypes; track type){
          <li (click)="assignColumnType(type)">
            {{ type }}
          </li>
        }
      </ul>
    </li>
    <li (click)="deleteColumn(contextMenuColIndex)">Delete Column</li>
    <li (click)="mergeIndividualAndFamilyColumns()">Merge family/individual columns</li>
    <li (click)="processSingleHpoColumn(contextMenuColIndex)">Process single HPO column</li>
    <li (click)="markTransformed(contextMenuColIndex)">Mark column as transformed</li>
  </ul>
</div>
}
  @if (contextMenuCellVisible) {
    <div class="context-menu-visible"
        [style.top.px]="contextMenuCellY" 
        [style.left.px]="contextMenuCellX"
        (click)="contextMenuCellVisible = false"
    >
      <div style="padding: 5px 0; font-weight: bold;">
        Value: "{{ contextMenuCellValue }}"<br />
        Type: {{ contextMenuCellType }}
      </div>
      <ul style="margin: 8px 0 0 0; padding: 0; list-style: none;">
        <li
          style="padding: 4px 8px; cursor: pointer;"
          (click)="editCellValueManually()"
        >
           <mat-icon>edit</mat-icon> Edit cell contents
        </li>
       @if (hasValueAbove()) {
          <li (click)="useValueFromAbove()">
            <mat-icon>content_copy</mat-icon> Copy value from above
          </li>
        }
      </ul>
    </div>
  }
@if (transformationPanelVisible) {
  <div class="transformation-panel">
    <h3>Transform values in column: {{ contextMenuColHeader }}</h3>
    <div *ngFor="let val of uniqueValuesToMap" class="transform-row">
      <label>
        {{ val }} →
        <input [(ngModel)]="transformationMap[val]" class="transform-input" />
      </label>
    </div>
    <button (click)="applyValueTransform()">Apply Transformation</button>
  </div>
}

@if(editPreviewColumnVisible){
  <div class="confirm-transform-box">
    <button (click)="confirmValueTransformation()">✅ Confirm Transformation</button>
    <button (click)="cancelTransformation()">❌ Cancel</button>
  </div>
}

@if(editModalVisible) {
<div class="edit-modal">
  <h4><strong>Edit Cell Value</strong>:</h4>
  <input
    [(ngModel)]="editingValue"
    style="
      width: 100%;
      margin-top: 10px;
      padding: 6px 10px;
      border: 2px solid #007acc;
      border-radius: 4px;
      font-size: 14px;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    "
  />
  <div style="margin-top: 16px; text-align: right;">
    <button (click)="saveManualEdit()">Save</button>
    <button (click)="editModalVisible = false" style="margin-left: 8px;">Cancel</button>
  </div>
</div>
}
@if (previewModalVisible) {
<div class="preview-modal">
  <h3>Preview: {{ previewTransformName }} on Column</h3>
  <div class="scrollable-table-container">
    <table style="width: 100%; border-collapse: collapse; margin-top: 12px;">
      <thead>
        <tr>
          <th style="text-align: left; border-bottom: 1px solid #ccc;">Original</th>
          <th style="text-align: left; border-bottom: 1px solid #ccc;">Transformed</th>
        </tr>
      </thead>
      <tbody>
        @for (orig of previewOriginal; track i; let i=$index) {
          <tr>
            <td style="padding: 4px; border-bottom: 1px solid #eee;">{{ orig }}</td>
            <td style="padding: 4px; border-bottom: 1px solid #eee;">{{ previewTransformed[i] }}</td>
          </tr>
        }
      </tbody>
    </table>
  </div>
  <div style="text-align: right; margin-top: 16px; display: flex; justify-content: flex-end; gap: 8px;">
    <button (click)="applyTransformConfirmed()">✅ Apply</button>
    <button (click)="cancelValueTransformation()">Cancel</button>
  </div>
</div>
}