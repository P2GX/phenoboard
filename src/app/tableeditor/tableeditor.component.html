<div class="primary-box">
 <div class="heading-with-help">
        <h1>External Table Editor</h1>
        <app-help-button 
          title="External tables"
          [lines]="[
            'This page is for importing Supplemental tables (excel files) in which each row or column represents an individual.',
            'Users should transform the table column by column.',
            'You can save and load the external templates in multiple sessions. These JSON files should not be stored long-term (or checked into GitHub).'
          ]"
          helpUrl="https://p2gx.github.io/phenoboard/help/table-editor.html" />
     </div>
</div>

@if (statusService.hpoLoaded()) {
<div class="button-row flex flex-wrap gap-2 mb-6 p-2 bg-gray-50 rounded-md border border-gray-100">
  <div class="flex gap-1 border-r pr-3 border-gray-300">
    <button class="btn-sm btn-outline-primary" (click)="loadExcel(false)">üìÇ Excel (Cols)</button>
    <button class="btn-sm btn-outline-primary" (click)="loadExcel(true)">üìÇ Excel (Rows)</button>
  </div>

  <div class="flex gap-1 border-r pr-3 border-gray-300">
    <button class="btn-sm btn-outline-primary" (click)="saveExternalTemplateJson()">üíæ Save ETL</button>
    <button class="btn-sm btn-outline-primary" (click)="loadExternalTemplateJson()">üì• Load ETL</button>
  </div>

  <div class="flex gap-1">
    <button class="btn-sm btn-outline-primary" (click)="importCohortDiseaseData()">üß™ Import Disease</button>
    <button class="btn-sm btn-outline-primary" (click)="openPubmedDialog()">üîç PubMed</button>
    <button class="btn-primary btn-sm" (click)="addToCohortData()">‚ú® Add to Cohort</button>
  </div>
</div>
} @else {
  <div class="flex items-center gap-3 p-4 mb-6 bg-amber-50 border border-amber-200 rounded-lg text-amber-800">
    <mat-icon class="text-amber-600">warning</mat-icon>
    <div class="flex flex-col">
      <span class="font-bold text-sm">HPO Not Loaded</span>
      <span class="text-xs">The Table Editor requires the HPO ontology to validate terms. Please load HPO on the Home page to proceed.</span>
    </div>
  </div>
}

@if (errorMessage) {
  <div class="error-container">
    <div class="error-message">
      {{ errorMessage }}
    </div>
  </div>
}
@if (!this.etl_service.etlDto()) {
  <div>
    <p>No table loaded yet.</p>
  </div>
}

@if(this.etl_service.etlDto()) {
<div class="pt-table-container">
<table class="pt-table">
   <!-- ===== HEADER ROW ===== -->
  <tr>
    @for(col of this.etl_service.columns(); track $index; let i = $index){
    <th [ngClass]="
          etl_service.transformedColumns()[i]
            ? 'transformed-column'
            : i === visibleColIndex
              ? 'visible-column'
              : 'normal-column'
        "
        (contextmenu)="onRightClickHeader($event, i)">
      {{ col.header.original }}
    </th>
}
</tr>

  <!-- ===== TYPE ROW ===== -->
  <tr class="type-row">
    @for (col of columnsToRender(); track trackColumn($index, col); let colIndex = $index) {
       <th [ngClass]="getColumnClass(colIndex)"
          (contextmenu)="onRightClickHeader($event, colIndex)">
        {{ col.header.columnType }}
      </th>
    }
  </tr>
<!-- ===== DATA ROWS ===== -->
@for (row of displayRows(); track trackRow($index, row); let rowIndex = $index) {
  <tr>
    @for (col of columnsToRender(); track trackColumn($index, col); let colIndex = $index) {
        @if (isHpoTextMiningColumn(colIndex)) {
          <!-- HPO Text Mining Cell -->
            <td>
          <button
            class="hpo-button"
            [class.has-terms]="getHpoTermCount(colIndex, rowIndex) > 0"
            [matTooltip]="getHpoTooltipContent(colIndex, rowIndex)"
            matTooltipClass="hpo-tooltip-custom"
            matTooltipPosition="above"
            matTooltipShowDelay="500"
            (click)="openHpoMiningDialog(colIndex, rowIndex)"
          >
            <span class="icon">üîç</span>
            @if (getHpoTermCount(colIndex, rowIndex) > 0) {
              <span class="badge">{{ getHpoTermCount(colIndex, rowIndex) }}</span>
              <span 
                class="clear-btn" 
                (click)="clearHpoMining(colIndex, rowIndex); $event.stopPropagation()"
                matTooltip="Clear mined terms"
                matTooltipShowDelay="300"
              >√ó</span>
            }
          </button>
          </td>
        } @else {
          <td class="table-cell">
            <etl-cell
              [cell]="row[colIndex]"
              [rowIndex]="rowIndex"
              [colIndex]="colIndex"
              (contextMenuRequested)="onCellContextMenu($event)"
              (edited)="onCellEdited($event)"
            ></etl-cell>
          </td>
      }     
    } 
 </tr>
}
</table>
<div style="height: 40px;"></div>
</div>
}

<!-- Context menu for column headers -->
 @if (columnContextMenuVisible) {
<div
  [style.top.px]="columnContextMenuY"
  [style.left.px]="columnContextMenuX"
  class="context-menu"
>
  <div style="padding: 5px 12px; font-weight: bold;">
    Column: {{ contextMenuColHeader?.original }}<br />
    Type: {{ contextMenuColType }}
  </div>
  <ul>
    @if(contextMenuColIndex !== null) {
      <li (click)="startEditColumn(contextMenuColIndex); columnContextMenuVisible = false">Focus on Column</li>
      <li (click)="clearColumnFilter(); columnContextMenuVisible = false">Show All Columns</li>
      <li class="has-submenu">
        Set Column Type ‚ñ∏
        <ul class="submenu">
          @for (category of simpleColumnOperations; track category) {
            <li (click)="simpleColumnOp(contextMenuColIndex, category); columnContextMenuVisible = false">
              {{ category }}
            </li>
          }
        </ul>
     </li>
    }
    <li class="has-submenu">
  Transform Column ‚ñ∏
  <ul class="submenu">
    @for (category of transformCategories; track category.label) {
      <li class="has-submenu">
        {{ category.label }} ‚ñ∏
        <ul class="submenu">
          @for (t of category.transforms; track t) {
            <li (click)="applyNamedTransform(contextMenuColIndex, t); columnContextMenuVisible = false">
              {{ getTransformDisplayName(t) }}
            </li>
          }
        </ul>
      </li>
    }
  </ul>
</li>
  </ul>
</div>
}
  @if (contextMenuCellVisible) {
    <!-- activate by OnCellContextMenu -->
    <div class="context-menu-visible"
        [style.top.px]="contextMenuPosition?.y" 
        [style.left.px]="contextMenuPosition?.x"
        (click)="contextMenuCellVisible = false"
    >
    <div style="padding: 8px; font-size: 13px; line-height: 1.5;">
      
      <div><strong>Original:</strong> {{ contextMenuCellValue?.original }}</div>
      <div><strong>Current:</strong> {{ contextMenuCellValue?.current }}</div>
      <div style="border-bottom: 1px solid #ccc; margin-bottom: 5px; padding-bottom: 5px;">
        <strong>Status:</strong> {{ getStatusSymbol(contextMenuCellValue) }} 
        <span style="text-transform: capitalize;">{{ contextMenuCellValue?.status }}</span>
      </div>
      </div>
      <ul style="margin: 8px 0 0 0; padding: 0; list-style: none;">
        <li
          style="padding: 4px 8px; cursor: pointer;"
          (click)="editCellValueManually()"
        >
           <mat-icon>edit</mat-icon> Edit cell contents
        </li>
        <li
          style="padding: 4px 8px; cursor: pointer;"
          (click)="deleteRow()"
        >
           <mat-icon>delete</mat-icon> Delete row
        </li>
       @if (hasValueAbove()) {
          <li (click)="useValueFromAbove()">
            <mat-icon>content_copy</mat-icon> Copy value from above
          </li>
        }
        <li
          style="padding: 4px 8px; cursor: pointer;"
          (click)="openHgvsEditor()"
        >
           <mat-icon>science</mat-icon>Manually add HGVS
        </li>
         <li
          style="padding: 4px 8px; cursor: pointer;"
          (click)="openSvEditor()"
        >
           <mat-icon>account_tree</mat-icon>Manually add Structural Variant
        </li>
      </ul>
    </div>
  }


@if(editModalVisible) {
  <div class="edit-modal"
        [style.top.px]="contextMenuPosition?.y" 
        [style.left.px]="contextMenuPosition?.x"
        (mousedown)="editModalVisible = false"
    >
    <div style="padding: 8px; font-size: 13px; line-height: 1.5;" (mousedown)="$event.stopPropagation()">
    <header>
      <mat-icon>edit</mat-icon>
      <h3>Edit Cell Value</h3>
    </header>
    
    <div class="modal-body">
      <label>
        <span class="value-badge original">Original: {{ editingValue?.original || "n/a" }}</span>
        <span class="value-badge transformed">Transformed: {{ editingValue?.current || "n/a" }}</span>
      </label>
      <input
        id="cell-edit"
        [(ngModel)]="editingString"
        (keyup.enter)="saveManualEdit()"
        placeholder="Enter new value..."
        autofocus
        autocapitalize="none"
        spellcheck="false"
        autocomplete="off"
      />
    </div>

    <div class="modal-actions">
      <button class="btn-secondary" (click)="editModalVisible = false">Cancel</button>
      <button class="btn-primary" (click)="saveManualEdit()">Save Changes</button>
    </div>
  </div>
</div>
}